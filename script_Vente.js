// Variable globale pour stocker la localisation
let vendLocation = null;

// V√©rifie si l'environnement est Cordova (application mobile) ou un navigateur classique
const isCordova = !!window.cordova;

// Charge les fonctionnalit√©s d√®s que Cordova ou le DOM est pr√™t
document.addEventListener(isCordova ? 'deviceready' : 'DOMContentLoaded', initializeLocationCheck);

// Initialisation de la v√©rification de localisation
function initializeLocationCheck() {
    if (isCordova) {
        checkGPSAndRequestPermission(); // V√©rification GPS et permissions sous Cordova
    } else {
        checkBrowserGeolocation(); // V√©rification g√©olocalisation sur navigateur
    }
}

// V√©rifie si le GPS est activ√© et demande les permissions sous Cordova
function checkGPSAndRequestPermission() {
    if (!cordova.plugins || !cordova.plugins.diagnostic) {
        showAlert("‚ùå Plugin de diagnostic indisponible. Impossible de v√©rifier le GPS.");
        return;
    }

    cordova.plugins.diagnostic.isLocationEnabled(
        function (enabled) {
            if (enabled) {
                checkCordovaPermission();
            } else {
                // Demande √† l'utilisateur d'activer le GPS
                cordova.plugins.diagnostic.switchToLocationSettings();
                setTimeout(() => {
                    cordova.plugins.diagnostic.isLocationEnabled(
                        function (enabledAfterSwitch) {
                            if (enabledAfterSwitch) {
                                checkCordovaPermission();
                            } else {
                                showAlert("‚ùå Veuillez activer le GPS pour continuer.");
                            }
                        },
                        function (error) {
                            showAlert("‚ùå Erreur lors de la v√©rification du GPS : " + error);
                        }
                    );
                }, 5000);
            }
        },
        function (error) {
            showAlert("‚ùå Erreur lors de la v√©rification du GPS : " + error);
        }
    );
}

// V√©rifie et demande les permissions de localisation sous Cordova
function checkCordovaPermission() {
    if (!cordova.plugins || !cordova.plugins.permissions) {
        showAlert("‚ùå Plugin de permissions indisponible. Impossible de v√©rifier les permissions.");
        return;
    }

    const permissions = cordova.plugins.permissions;

    permissions.checkPermission(permissions.ACCESS_FINE_LOCATION, function (status) {
        if (status.hasPermission) {
            requestGeolocation();
        } else {
            permissions.requestPermission(permissions.ACCESS_FINE_LOCATION, function (status) {
                if (status.hasPermission) {
                    requestGeolocation();
                } else {
                    showAlert("‚ùå Permission de localisation refus√©e. Veuillez l'activer dans vos param√®tres.");
                }
            }, function () {
                showAlert("‚ùå La permission de localisation est obligatoire pour continuer.");
            });
        }
    }, function () {
        showAlert("‚ùå Impossible de v√©rifier les permissions. V√©rifiez vos param√®tres.");
    });
}

// V√©rifie et demande la g√©olocalisation pour un navigateur
function checkBrowserGeolocation() {
    if (!navigator.geolocation) {
        showAlert("‚ùå La g√©olocalisation n'est pas support√©e par votre navigateur.");
        return;
    }

    // V√©rifie si la permission est d√©j√† accord√©e (sur les navigateurs modernes)
    if (navigator.permissions) {
        navigator.permissions.query({ name: "geolocation" })
            .then(function (result) {
                if (result.state === "granted" || result.state === "prompt") {
                    requestGeolocation();
                } else {
                    showAlert("‚ùå Permission de localisation refus√©e. Activez-la dans vos param√®tres.");
                }
            })
            .catch(function (error) {
                showAlert("‚ùå Erreur lors de la v√©rification des permissions : " + error);
            });
    } else {
        requestGeolocation();
    }
}

// Demande la position g√©ographique (utilis√© pour Cordova et navigateur)
function requestGeolocation() {
    navigator.geolocation.getCurrentPosition(
        function (position) {
            vendLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };
            console.log("üìç Position d√©tect√©e :", vendLocation);
        },
        function (error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    showAlert("‚ùå Permission de localisation refus√©e. Veuillez l'activer dans les param√®tres.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    showAlert("‚ùå Position indisponible. V√©rifiez si votre GPS fonctionne.");
                    break;
                case error.TIMEOUT:
                    showAlert("‚ùå D√©lai d'attente d√©pass√©. Essayez √† nouveau.");
                    break;
                default:
                    showAlert("‚ùå Erreur inconnue : " + error.message);
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// Fonction pour afficher une alerte (√† adapter selon ton interface)
function showAlert(message) {
    alert(message); // Utilise une alerte basique, peut √™tre remplac√©e par un modal personnalis√©
}


// Gestion du formulaire de vente
document.getElementById('vente-form').addEventListener('submit', function (e) {
    e.preventDefault();

    // V√©rifie que la localisation est activ√©e
    if (!vendLocation) {
        showAlert("‚ùå La localisation doit √™tre activ√©e pour soumettre le formulaire.");
        return;
    }




    // Calcul des prix et commission
    const prixUnitaire = parseFloat(document.getElementById('prix').value);
    const commission = prixUnitaire * 0.04;
    const prixFinal = prixUnitaire + commission;

// Cr√©ation de l'objet animal
const animal = {
    usernameVendeur: document.getElementById('username-vendeur').value, // Ajout du nom d'utilisateur du vendeur
    categorie: document.getElementById('categorie').value,
    nombre: document.getElementById('nombre').value,
    poids: document.getElementById('poids').value,
    prix: prixUnitaire,
    prixFinal: prixFinal.toFixed(2),
    images: [], // Vous pouvez remplir ce tableau si n√©cessaire pour inclure les fichiers s√©lectionn√©s
    contactPrincipal: document.getElementById('contact-principal').value,
    contactSecondaire: document.getElementById('contact-secondaire').value,
    emailVendeur: document.getElementById('email-vendeur').value,
    codeVendeur: 'Annonce N¬∞' + Date.now(), // G√©n√®re un code unique bas√© sur le timestamp
    location: vendLocation // La localisation ajout√©e ici
};

    console.log("Infos animal :", animal);

// Traitement des images et envoi des donn√©es
sendData(animal);


});



// Fonction pour envoyer les donn√©es de l'annonce
function sendData(animal) {
    const files = document.getElementById('images').files;
    if (files.length === 0) {
        showAlert("‚ùå Veuillez s√©lectionner au moins une image.");
        return;
    }

    const processImages = Array.from(files).map(file => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = event => {
                const img = new Image();
                img.onload = () => {
                    const maxWidth = 600;
                    const maxHeight = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        if (width > height) {
                            height = Math.floor((height * maxWidth) / width);
                            width = maxWidth;
                        } else {
                            width = Math.floor((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedImage = canvas.toDataURL('image/jpeg', 0.6);
                    resolve(compressedImage);
                };
                img.onerror = reject;
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    });

    Promise.all(processImages).then(images => {
        animal.images = images;

    // Assure-toi que `location` est bien inclus
    console.log("Objet envoy√© au serveur :", JSON.stringify(animal));

        fetch('https://farmsconnect.netlify.app/.netlify/functions/annonces', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(animal)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Erreur HTTP : ${response.status} - ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Annonce envoy√©e avec succ√®s", data);
            showAlert(successMessage, linkMessage);
        
            // Recharge la page apr√®s l'envoi
            setTimeout(() => {
                location.reload(); // Recharge la page apr√®s un d√©lai de 1 seconde
            }, 7000);
        })

        
        
        .catch(error => {
            showAlert("Erreur lors de l'envoi : " + error.message);
        });
    });
}

// Fonction pour afficher un message d'alerte
function showAlert(message) {
    const alertBox = document.getElementById("customAlert");
    const alertMessage = document.getElementById("alertMessage");

    alertMessage.textContent = message;
    alertBox.classList.add("visible");

    setTimeout(() => closeAlert(), 10000);
}

// Fonction pour fermer l'alerte
function closeAlert() {
    const alertBox = document.getElementById("customAlert");
    alertBox.classList.remove("visible");
}
